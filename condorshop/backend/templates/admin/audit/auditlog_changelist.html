{% extends "admin/change_list.html" %}
{% load static %}

{% block content %}

<!-- ========== DASHBOARD DE AUDITOR√çA ========== -->
<div style="padding: 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: -20px -20px 20px -20px; border-radius: 0 0 12px 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
    
    <!-- T√≠tulo del Dashboard -->
    <h2 style="color: white; margin: 0 0 24px 0; font-size: 24px; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
        üîç Panel de Auditor√≠a - CondorShop
    </h2>
    
    <!-- Mensaje de error si existe -->
    {% if dashboard_error %}
    <div style="margin-bottom: 20px; padding: 16px; background: rgba(220, 53, 69, 0.1); border-radius: 8px; border-left: 4px solid #dc3545;">
        <p style="margin: 0; font-size: 13px; color: #721c24; line-height: 1.6;">
            <strong>‚ö†Ô∏è Advertencia:</strong> Error al cargar m√©tricas del dashboard: {{ dashboard_error }}
        </p>
    </div>
    {% endif %}
    
    <!-- ========== TARJETAS DE M√âTRICAS ========== -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 24px;">
        
        <!-- Tarjeta 1: Total de Acciones -->
        <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 6px 16px rgba(0,0,0,0.12); transition: transform 0.2s;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div style="flex: 1;">
                    <p style="margin: 0; font-size: 13px; color: #6c757d; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Total de Acciones</p>
                    <p style="margin: 8px 0 0; font-size: 42px; font-weight: 800; color: #007bff; line-height: 1;">{{ total_actions }}</p>
                    <p style="margin: 6px 0 0; font-size: 12px; color: #6c757d;">√öltimos 7 d√≠as</p>
                </div>
                <div style="font-size: 52px; opacity: 0.8;">üìä</div>
            </div>
        </div>
        
        <!-- Tarjeta 2: Acciones Cr√≠ticas -->
        <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 6px 16px rgba(0,0,0,0.12); transition: transform 0.2s;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div style="flex: 1;">
                    <p style="margin: 0; font-size: 13px; color: #6c757d; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Acciones Cr√≠ticas</p>
                    <p style="margin: 8px 0 0; font-size: 42px; font-weight: 800; color: #fd7e14; line-height: 1;">{{ critical_actions }}</p>
                    <p style="margin: 6px 0 0; font-size: 12px; color: #6c757d;">Orders + Products + Payments</p>
                </div>
                <div style="font-size: 52px; opacity: 0.8;">‚ö†Ô∏è</div>
            </div>
        </div>
        
        <!-- Tarjeta 3: Usuarios Activos -->
        <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 6px 16px rgba(0,0,0,0.12); transition: transform 0.2s;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div style="flex: 1;">
                    <p style="margin: 0; font-size: 13px; color: #6c757d; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Usuarios Activos</p>
                    <p style="margin: 8px 0 0; font-size: 42px; font-weight: 800; color: #28a745; line-height: 1;">{{ unique_users }}</p>
                    <p style="margin: 6px 0 0; font-size: 12px; color: #6c757d;">Usuarios √∫nicos registrados</p>
                </div>
                <div style="font-size: 52px; opacity: 0.8;">üë•</div>
            </div>
        </div>
    </div>
    
    <!-- ========== GR√ÅFICOS ========== -->
    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
        
        <!-- Gr√°fico 1: Actividad Temporal (7 d√≠as) -->
        <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 6px 16px rgba(0,0,0,0.12);">
            <h3 style="margin: 0 0 20px 0; font-size: 17px; font-weight: 700; color: #212529; display: flex; align-items: center; gap: 8px;">
                <span>üìà</span>
                <span>Actividad de los √öltimos 7 D√≠as</span>
            </h3>
            <canvas id="activityChart" style="max-height: 280px;"></canvas>
        </div>
        
        <!-- Gr√°fico 2: Distribuci√≥n por Tipo de Acci√≥n -->
        <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 6px 16px rgba(0,0,0,0.12);">
            <h3 style="margin: 0 0 20px 0; font-size: 17px; font-weight: 700; color: #212529; display: flex; align-items: center; gap: 8px;">
                <span>üìä</span>
                <span>Por Tipo de Acci√≥n</span>
            </h3>
            <canvas id="actionTypesChart" style="max-height: 280px;"></canvas>
        </div>
    </div>
    
    <!-- Nota informativa -->
    <div style="margin-top: 20px; padding: 16px; background: rgba(255, 255, 255, 0.95); border-radius: 8px; border-left: 4px solid #ffc107;">
        <p style="margin: 0; font-size: 13px; color: #856404; line-height: 1.6;">
            <strong>‚ÑπÔ∏è Informaci√≥n:</strong> Este panel muestra actividad en tiempo real del sistema. 
            Los registros son inmutables (no editables) por requisitos legales de trazabilidad. 
            Configurado por <strong>AuditMiddleware</strong> autom√°tico.
        </p>
    </div>
</div>

<!-- ========== LISTADO DE REGISTROS (TABLA EST√ÅNDAR) ========== -->
{{ block.super }}

<!-- ========== JAVASCRIPT: CHART.JS Y CONFIGURACI√ìN ========== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js" 
        onerror="console.error('‚ö†Ô∏è Error cargando Chart.js desde CDN. Verifica la conexi√≥n a internet.'); this.onerror=null;">
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ Dashboard de Auditor√≠a cargado');
    
    // ========== GR√ÅFICO 1: ACTIVIDAD TEMPORAL ========== 
    const activityCtx = document.getElementById('activityChart');
    
    if (!activityCtx) {
        console.error('‚ùå Canvas #activityChart no encontrado');
    } else {
        const dailyLabels = {{ daily_actions_labels|safe }};
        const dailyData = {{ daily_actions_data|safe }};
        
        // Calcular stepSize din√°mico basado en el m√°ximo valor
        const maxValue = Math.max(...dailyData, 1); // M√≠nimo 1 para evitar divisi√≥n por 0
        // Calcular stepSize: redondear hacia arriba el m√°ximo dividido por 10
        // Esto garantiza aproximadamente 10 ticks m√°ximo
        let calculatedStepSize = Math.ceil(maxValue / 10);
        // Si el stepSize es muy peque√±o (< 1), usar 1
        // Si es muy grande, redondear a m√∫ltiplos de 10, 100, 1000, etc.
        if (calculatedStepSize < 1) {
            calculatedStepSize = 1;
        } else if (calculatedStepSize > 1000) {
            // Redondear a m√∫ltiplos de 1000
            calculatedStepSize = Math.ceil(calculatedStepSize / 1000) * 1000;
        } else if (calculatedStepSize > 100) {
            // Redondear a m√∫ltiplos de 100
            calculatedStepSize = Math.ceil(calculatedStepSize / 100) * 100;
        } else if (calculatedStepSize > 10) {
            // Redondear a m√∫ltiplos de 10
            calculatedStepSize = Math.ceil(calculatedStepSize / 10) * 10;
        }
        
        new Chart(activityCtx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: dailyLabels,
                datasets: [{
                    label: 'Acciones Registradas',
                    data: dailyData,
                    backgroundColor: 'rgba(102, 126, 234, 0.7)',
                    borderColor: 'rgba(102, 126, 234, 1)',
                    borderWidth: 2,
                    borderRadius: 8,
                    hoverBackgroundColor: 'rgba(102, 126, 234, 0.9)',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.85)',
                        padding: 14,
                        titleFont: {
                            size: 15,
                            weight: '600'
                        },
                        bodyFont: {
                            size: 14
                        },
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                return 'Acciones: ' + context.parsed.y;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: calculatedStepSize,
                            font: {
                                size: 12,
                                weight: '500'
                            },
                            color: '#495057',
                            // Formatear n√∫meros grandes con separadores de miles
                            callback: function(value) {
                                if (value >= 1000) {
                                    return (value / 1000).toFixed(1) + 'k';
                                }
                                return value;
                            }
                        },
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.06)',
                            lineWidth: 1
                        }
                    },
                    x: {
                        ticks: {
                            font: {
                                size: 12,
                                weight: '500'
                            },
                            color: '#495057'
                        },
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
        console.log('‚úÖ Gr√°fico de actividad temporal creado (stepSize: ' + calculatedStepSize + ')');
    }
    
    // ========== GR√ÅFICO 2: DISTRIBUCI√ìN POR TIPO ========== 
    const actionTypesCtx = document.getElementById('actionTypesChart');
    
    if (!actionTypesCtx) {
        console.error('‚ùå Canvas #actionTypesChart no encontrado');
    } else {
        const actionLabels = {{ action_labels|safe }};
        const actionCounts = {{ action_counts|safe }};
        
        // Colores seg√∫n tipo de acci√≥n
        const actionColors = {
            'CREATE': 'rgba(40, 167, 69, 0.8)',
            'UPDATE': 'rgba(255, 193, 7, 0.8)',
            'DELETE': 'rgba(220, 53, 69, 0.8)',
            'VIEW': 'rgba(23, 162, 184, 0.8)',
            'UNKNOWN': 'rgba(108, 117, 125, 0.8)'
        };
        
        const backgroundColors = actionLabels.map(label => 
            actionColors[label] || 'rgba(108, 117, 125, 0.8)'
        );
        
        new Chart(actionTypesCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: actionLabels,
                datasets: [{
                    data: actionCounts,
                    backgroundColor: backgroundColors,
                    borderWidth: 3,
                    borderColor: '#ffffff',
                    hoverBorderWidth: 4,
                    hoverBorderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 16,
                            font: {
                                size: 13,
                                weight: '600'
                            },
                            color: '#212529',
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.85)',
                        padding: 14,
                        titleFont: {
                            size: 15,
                            weight: '600'
                        },
                        bodyFont: {
                            size: 14
                        },
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
        console.log('‚úÖ Gr√°fico de tipos de acci√≥n creado');
    }
});
</script>

<style>
/* Hover effects en tarjetas */
div[style*="box-shadow: 0 6px 16px"]:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.16) !important;
}
</style>

{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
    /* ===== MEJORAS DE PAGINACI√ìN ===== */
    .paginator {
        margin: 20px 0;
        text-align: center;
        padding: 15px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .paginator a,
    .paginator span.this-page {
        display: inline-block;
        padding: 10px 16px;
        margin: 0 5px;
        font-size: 16px;
        font-weight: 600;
        border-radius: 6px;
        transition: all 0.3s ease;
    }
    
    .paginator a {
        background-color: #ffffff;
        color: #5b7fa6;
        border: 2px solid #5b7fa6;
        text-decoration: none;
    }
    
    .paginator a:hover {
        background-color: #5b7fa6;
        color: #ffffff;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(91, 127, 166, 0.3);
    }
    
    .paginator span.this-page {
        background-color: #5b7fa6;
        color: #ffffff;
        border: 2px solid #5b7fa6;
        box-shadow: 0 2px 4px rgba(91, 127, 166, 0.4);
    }
    
    /* ===== MEJORAS DE FILTROS ===== */
    #changelist-filter {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
    }
    
    #changelist-filter h3 {
        background: linear-gradient(135deg, #5b7fa6 0%, #4a6a8a 100%);
        color: white;
        padding: 12px 15px;
        border-radius: 6px;
        cursor: pointer;
        margin: 10px 0 5px 0;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    #changelist-filter h3:hover {
        background: linear-gradient(135deg, #4a6a8a 0%, #3a5a7a 100%);
        transform: translateX(5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    #changelist-filter ul {
        padding: 10px;
        background-color: white;
        border-radius: 4px;
        margin-top: 5px;
    }
    
    /* ===== MEJORAS DE B√öSQUEDA ===== */
    #toolbar {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-expandir el primer filtro para mejor UX
        const firstFilter = document.querySelector('#changelist-filter h3');
        if (firstFilter) {
            const filterContent = firstFilter.nextElementSibling;
            if (filterContent && filterContent.style.display === 'none') {
                filterContent.style.display = 'block';
            }
        }
        
        // Agregar animaci√≥n suave al scroll
        document.querySelectorAll('.paginator a').forEach(link => {
            link.addEventListener('click', function(e) {
                // Scroll suave al tope de la tabla
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });
        });
    });
</script>
{% endblock %}

