from django.contrib import admin
from django.utils.html import format_html
from django.utils import timezone
from django.db.models import Count
from django.db.models.functions import TruncDate
from datetime import timedelta
import json
from .models import AuditLog


class CriticalTablesFilter(admin.SimpleListFilter):
    """Filtro personalizado para acciones cr√≠ticas del negocio"""
    title = 'Tipo de operaci√≥n'
    parameter_name = 'operation_type'
    
    def lookups(self, request, model_admin):
        return (
            ('critical', '‚ö†Ô∏è Cr√≠ticas (Orders + Products + Payments)'),
            ('orders', 'üì¶ Solo Orders'),
            ('products', 'üè∑Ô∏è Solo Products'),
            ('payments', 'üí≥ Solo Payments'),
            ('inventory', 'üìä Solo Inventory'),
        )
    
    def queryset(self, request, queryset):
        if self.value() == 'critical':
            return queryset.filter(
                table_name__in=['orders', 'order_items', 'products', 'payments', 'payment_transactions']
            )
        elif self.value() == 'orders':
            return queryset.filter(table_name__in=['orders', 'order_items'])
        elif self.value() == 'products':
            return queryset.filter(table_name='products')
        elif self.value() == 'payments':
            return queryset.filter(table_name__in=['payments', 'payment_transactions'])
        elif self.value() == 'inventory':
            return queryset.filter(table_name='inventory_movements')
        return queryset


@admin.register(AuditLog)
class AuditLogAdmin(admin.ModelAdmin):
    # Template personalizado con dashboard
    change_list_template = 'admin/audit/auditlog_changelist.html'
    
    # Campos a mostrar en el listado
    list_display = [
        'id',
        'colored_action',
        'table_name_badge',
        'user_display',
        'formatted_timestamp',
        'ip_address_display',
        'record_id',
    ]
    
    # Filtros laterales
    list_filter = [
        CriticalTablesFilter,
        'action',
        ('created_at', admin.DateFieldListFilter),
        'table_name',
    ]
    
    # B√∫squeda
    search_fields = [
        'user__email',
        'table_name',
        'ip_address',
        'record_id',
    ]
    
    # Campos de solo lectura en vista detalle
    readonly_fields = [
        'id',
        'user',
        'action',
        'table_name',
        'record_id',
        'formatted_old_values',
        'formatted_new_values',
        'ip_address',
        'created_at',
    ]
    
    # Configuraci√≥n general
    list_per_page = 50
    ordering = ['-created_at']
    # date_hierarchy removido temporalmente debido a problemas con MySQL timezone
    # Se puede reactivar cuando MySQL tenga timezone tables instaladas
    
    # ===== PERMISOS (SOLO LECTURA) =====
    
    def has_add_permission(self, request):
        """Bloquear creaci√≥n manual - auditor√≠a autom√°tica solamente"""
        return False
    
    def has_change_permission(self, request, obj=None):
        """Bloquear edici√≥n - mantener integridad de auditor√≠a"""
        return False
    
    def has_delete_permission(self, request, obj=None):
        """Bloquear eliminaci√≥n - requisito legal de trazabilidad"""
        return False
    
    # ===== OPTIMIZACI√ìN DE QUERIES =====
    
    def get_queryset(self, request):
        """Optimizar con select_related para evitar N+1 queries"""
        return super().get_queryset(request).select_related('user')
    
    # ===== COLUMNAS PERSONALIZADAS =====
    
    def colored_action(self, obj):
        """Badge HTML con colores seg√∫n tipo de acci√≥n"""
        badges = {
            'CREATE': '<span style="background: #28a745; color: white; padding: 5px 12px; border-radius: 6px; font-weight: 600; display: inline-block; font-size: 11px; letter-spacing: 0.5px;">‚úì CREATE</span>',
            'UPDATE': '<span style="background: #ffc107; color: #212529; padding: 5px 12px; border-radius: 6px; font-weight: 600; display: inline-block; font-size: 11px; letter-spacing: 0.5px;">‚úé UPDATE</span>',
            'DELETE': '<span style="background: #dc3545; color: white; padding: 5px 12px; border-radius: 6px; font-weight: 600; display: inline-block; font-size: 11px; letter-spacing: 0.5px;">‚úó DELETE</span>',
            'VIEW': '<span style="background: #17a2b8; color: white; padding: 5px 12px; border-radius: 6px; font-weight: 600; display: inline-block; font-size: 11px; letter-spacing: 0.5px;">üëÅ VIEW</span>',
            'UNKNOWN': '<span style="background: #6c757d; color: white; padding: 5px 12px; border-radius: 6px; font-weight: 600; display: inline-block; font-size: 11px; letter-spacing: 0.5px;">? UNKNOWN</span>',
        }
        return format_html(badges.get(obj.action, f'<span style="color: #6c757d;">{obj.action}</span>'))
    colored_action.short_description = 'Acci√≥n'
    
    def table_name_badge(self, obj):
        """Tabla con badge de color seg√∫n criticidad"""
        critical_tables = ['orders', 'order_items', 'products', 'payments', 'payment_transactions']
        if obj.table_name in critical_tables:
            return format_html(
                '<span style="background: #fff3cd; color: #856404; padding: 4px 10px; border-radius: 4px; font-weight: 500; font-size: 12px;">‚ö†Ô∏è {}</span>',
                obj.table_name
            )
        return format_html(
            '<span style="color: #495057; font-weight: 500;">{}</span>',
            obj.table_name
        )
    table_name_badge.short_description = 'Tabla'
    table_name_badge.admin_order_field = 'table_name'
    
    def user_display(self, obj):
        """Mostrar email del usuario o 'An√≥nimo' si no existe"""
        if obj.user:
            return format_html(
                '<span style="color: #007bff; font-weight: 500;">{}</span>',
                obj.user.email
            )
        return format_html('<em style="color: #6c757d;">An√≥nimo</em>')
    user_display.short_description = 'Usuario'
    user_display.admin_order_field = 'user__email'
    
    def formatted_timestamp(self, obj):
        """Formato legible: 15 nov 2025, 14:30"""
        return obj.created_at.strftime('%d %b %Y, %H:%M')
    formatted_timestamp.short_description = 'Fecha y Hora'
    formatted_timestamp.admin_order_field = 'created_at'
    
    def ip_address_display(self, obj):
        """Mostrar IP o 'No registrada'"""
        if obj.ip_address:
            return format_html(
                '<code style="background: #f8f9fa; padding: 2px 6px; border-radius: 3px; font-size: 12px;">{}</code>',
                obj.ip_address
            )
        return format_html('<em style="color: #6c757d;">No registrada</em>')
    ip_address_display.short_description = 'IP'
    
    def formatted_old_values(self, obj):
        """JSON formateado con indentaci√≥n y colores"""
        if not obj.old_values:
            return format_html('<em style="color: #6c757d;">Sin valores previos (creaci√≥n nueva)</em>')
        try:
            formatted = json.dumps(obj.old_values, indent=2, ensure_ascii=False, sort_keys=True)
            return format_html(
                '<pre style="background: #f8f9fa; padding: 12px; border-radius: 6px; border-left: 4px solid #dc3545; overflow-x: auto; font-size: 13px; line-height: 1.5;">{}</pre>',
                formatted
            )
        except Exception as e:
            return format_html(
                '<span style="color: #dc3545;">Error al formatear JSON: {}</span>',
                str(e)
            )
    formatted_old_values.short_description = 'üìÑ Valores Anteriores (JSON)'
    
    def formatted_new_values(self, obj):
        """JSON formateado con indentaci√≥n y colores"""
        if not obj.new_values:
            return format_html('<em style="color: #6c757d;">Sin valores nuevos (eliminaci√≥n o consulta)</em>')
        try:
            formatted = json.dumps(obj.new_values, indent=2, ensure_ascii=False, sort_keys=True)
            return format_html(
                '<pre style="background: #f8f9fa; padding: 12px; border-radius: 6px; border-left: 4px solid #28a745; overflow-x: auto; font-size: 13px; line-height: 1.5;">{}</pre>',
                formatted
            )
        except Exception as e:
            return format_html(
                '<span style="color: #dc3545;">Error al formatear JSON: {}</span>',
                str(e)
            )
    formatted_new_values.short_description = 'üìÑ Valores Nuevos (JSON)'
    
    # ===== DATOS PARA DASHBOARD =====
    
    def changelist_view(self, request, extra_context=None):
        """Agregar m√©tricas y datos para gr√°ficos del dashboard"""
        try:
            # Calcular rango de 7 d√≠as (timezone-aware)
            seven_days_ago = timezone.now() - timedelta(days=7)
            
            # M√©trica 1: Total de acciones √∫ltimos 7 d√≠as
            total_actions = AuditLog.objects.filter(
                created_at__gte=seven_days_ago
            ).count()
            
            # M√©trica 2: Acciones cr√≠ticas √∫ltimos 7 d√≠as
            critical_actions = AuditLog.objects.filter(
                created_at__gte=seven_days_ago,
                table_name__in=[
                    'orders', 'order_items', 'products', 
                    'payments', 'payment_transactions'
                ]
            ).count()
            
            # M√©trica 3: Usuarios √∫nicos activos √∫ltimos 7 d√≠as
            unique_users = AuditLog.objects.filter(
                created_at__gte=seven_days_ago,
                user__isnull=False
            ).values('user').distinct().count()
            
            # Datos para gr√°fico: Garantizar 7 d√≠as de datos (incluso si count=0)
            # Usar TruncDate para evitar problemas con timezone en MySQL
            daily_data = []
            for i in range(7):
                target_date = timezone.now() - timedelta(days=6-i)
                # Usar TruncDate para extraer solo la fecha sin problemas de timezone
                count = AuditLog.objects.filter(
                    created_at__gte=target_date.replace(hour=0, minute=0, second=0, microsecond=0),
                    created_at__lt=(target_date + timedelta(days=1)).replace(hour=0, minute=0, second=0, microsecond=0)
                ).count()
                daily_data.append({
                    'date': target_date.strftime('%d %b'),  # "15 nov"
                    'count': count
                })
            
            # Datos para gr√°fico de acciones por tipo
            action_stats = AuditLog.objects.filter(
                created_at__gte=seven_days_ago
            ).values('action').annotate(
                count=Count('id')
            ).order_by('-count')
            
            action_labels = [stat['action'] for stat in action_stats]
            action_counts = [stat['count'] for stat in action_stats]
            
            # Agregar al contexto
            extra_context = extra_context or {}
            extra_context.update({
                'total_actions': total_actions,
                'critical_actions': critical_actions,
                'unique_users': unique_users,
                'daily_actions_labels': json.dumps([d['date'] for d in daily_data]),
                'daily_actions_data': json.dumps([d['count'] for d in daily_data]),
                'action_labels': json.dumps(action_labels),
                'action_counts': json.dumps(action_counts),
            })
        except Exception as e:
            # Si hay error, usar valores por defecto para que el admin siga funcionando
            extra_context = extra_context or {}
            extra_context.update({
                'total_actions': 0,
                'critical_actions': 0,
                'unique_users': 0,
                'daily_actions_labels': json.dumps([]),
                'daily_actions_data': json.dumps([]),
                'action_labels': json.dumps([]),
                'action_counts': json.dumps([]),
                'dashboard_error': str(e),
            })
        
        return super().changelist_view(request, extra_context=extra_context)

from django.contrib import admin
from .models import AuditLog


@admin.register(AuditLog)
class AuditLogAdmin(admin.ModelAdmin):
    list_display = ('id', 'user', 'action', 'table_name', 'record_id', 'ip_address', 'created_at')
    list_filter = ('action', 'table_name', 'created_at')
    search_fields = ('user__email', 'table_name', 'action')
    readonly_fields = ('id', 'user', 'action', 'table_name', 'record_id', 
                      'old_values', 'new_values', 'ip_address', 'created_at')
    
    def user(self, obj):
        return obj.user.email if obj.user else 'An√≥nimo'
    user.short_description = 'Usuario'
    user.admin_order_field = 'user__email'
    
    def action(self, obj):
        return obj.action
    action.short_description = 'Acci√≥n'
    action.admin_order_field = 'action'
    
    def table_name(self, obj):
        return obj.table_name
    table_name.short_description = 'Nombre de tabla'
    table_name.admin_order_field = 'table_name'
    
    def record_id(self, obj):
        return obj.record_id or '-'
    record_id.short_description = 'ID del registro'
    record_id.admin_order_field = 'record_id'
    
    def ip_address(self, obj):
        return obj.ip_address or '-'
    ip_address.short_description = 'Direcci√≥n IP'
    ip_address.admin_order_field = 'ip_address'
    
    def created_at(self, obj):
        return obj.created_at.strftime('%d de %B de %Y a las %H:%M') if obj.created_at else '-'
    created_at.short_description = 'Creado el'
    created_at.admin_order_field = 'created_at'
    
    def has_add_permission(self, request):
        return False
    
    def has_change_permission(self, request, obj=None):
        return False

